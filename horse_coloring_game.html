<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>小馬著色遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #canvas-container {
            width: 680px;
            height: 680px;
            position: relative;
            background-image: url('./horse-outline.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
        .tool-btn {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .tool-btn.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            border-color: #fff;
        }
    </style>
</head>
<body class="bg-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="root"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CANVAS_WIDTH = 680;
        const CANVAS_HEIGHT = 680;

        const App = () => {
            const [gameState, setGameState] = useState('start'); // 'start' or 'playing'
            const canvasRef = useRef(null);
            const audioRef = useRef(null);
            const lastPointRef = useRef(null); // 儲存上一個點的位置
            
            const [color, setColor] = useState('#ff0000');
            const [brushSize, setBrushSize] = useState(10);

            useEffect(() => {
                if (gameState !== 'playing') return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = color;
                ctx.lineWidth = brushSize;
            }, [gameState, color, brushSize]);

            // --- 1. 全新的開始遊戲函式 ---
            const handleStartGame = () => {
                setGameState('playing');
                // 關鍵一步：透過使用者點擊來「解鎖」音訊
                if (audioRef.current) {
                    audioRef.current.play().then(() => {
                        audioRef.current.pause(); // 播放後立刻暫停，只是為了取得權限
                    }).catch(e => console.error("音訊播放失敗:", e));
                }
            };

            const getCoords = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const event = e.touches ? e.touches[0] : e;
                return { x: event.clientX - rect.left, y: event.clientY - rect.top };
            };

            // --- 2. 全新的懸停繪畫邏輯 ---
            const drawOnMove = (e) => {
                const ctx = canvasRef.current.getContext('2d');
                const currentPoint = getCoords(e);

                if (lastPointRef.current) {
                    ctx.beginPath();
                    ctx.moveTo(lastPointRef.current.x, lastPointRef.current.y);
                    ctx.lineTo(currentPoint.x, currentPoint.y);
                    ctx.stroke();
                    
                    if (audioRef.current) {
                        audioRef.current.currentTime = 0;
                        audioRef.current.play().catch(err => {});
                    }
                }
                lastPointRef.current = currentPoint;
            };

            const handleMouseLeave = () => {
                lastPointRef.current = null; // 滑鼠離開畫布，清空上一個點
            };
            
            const clearCanvas = () => {
                const ctx = canvasRef.current.getContext('2d');
                ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            };

            // --- 3. 根據遊戲狀態顯示不同畫面 ---
            if (gameState === 'start') {
                return (
                    <div className="text-center">
                        <h1 className="text-5xl font-bold text-white mb-8">小馬著色遊戲</h1>
                        <button 
                            onClick={handleStartGame}
                            className="px-12 py-6 bg-green-500 text-white font-bold text-3xl rounded-lg hover:bg-green-400 transition-transform transform hover:scale-105"
                        >
                            開始遊戲
                        </button>
                        <audio ref={audioRef} src="./draw_sound.mp3" className="hidden" />
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center gap-4">
                    {/* 工具列 */}
                    <div className="bg-gray-700 p-3 rounded-lg flex flex-wrap items-center justify-center gap-4 shadow-lg">
                        {/* ... 顏色和粗細選擇 ... */}
                        <div className="flex items-center gap-3">
                            <span className="text-white font-semibold">顏色:</span>
                            {['#ff0000', '#0000ff', '#00ff00', '#ffff00', '#ff00ff', '#00ffff', '#000000', '#ffffff'].map(c => (
                                <button key={c} onClick={() => setColor(c)} className={`tool-btn w-10 h-10 rounded-full ${color === c ? 'selected' : ''}`} style={{ backgroundColor: c }} />
                            ))}
                        </div>
                        <div className="w-px h-10 bg-gray-500 mx-2"></div>
                        <div className="flex items-center gap-3">
                            <span className="text-white font-semibold">粗細:</span>
                            { [5, 10, 20, 30, 50].map(s => (
                                <button key={s} onClick={() => setBrushSize(s)} className={`tool-btn bg-gray-600 w-10 h-10 rounded-full flex items-center justify-center ${brushSize === s ? 'selected' : ''}`}>
                                    <div className="bg-white rounded-full" style={{width: s, height: s}}></div>
                                </button>
                            ))}
                        </div>
                        <div className="w-px h-10 bg-gray-500 mx-2"></div>
                        <button onClick={clearCanvas} className="bg-red-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-red-500">清除</button>
                    </div>

                    {/* 畫布區域 */}
                    <div id="canvas-container">
                        <canvas
                            id="drawing-canvas"
                            ref={canvasRef}
                            width={CANVAS_WIDTH}
                            height={CANVAS_HEIGHT}
                            onMouseMove={drawOnMove}
                            onMouseLeave={handleMouseLeave}
                            onTouchMove={drawOnMove}
                            onTouchEnd={handleMouseLeave}
                        />
                    </div>
                    <audio ref={audioRef} src="./draw_sound.mp3" className="hidden" />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
